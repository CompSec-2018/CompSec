# Lab 4: Real-life DDoS incident and malware behind it

## Background
This exercise is based on real-life incident, which happened some time ago in Finland. One service was target of distributed denial-of-service (DDoS), and was periodically taken down by it.
The cause (or guilty) wasn't very professional and some simple weakness was exploited in targeted service, which gives us a good example for researching.

The attacker had deployed botnet to perform DDoS attack to targeted service. Botnet was created by malicious software, spread by various methods.

In this exercise you will learn to analyze large-sized log file, and you are able notice how DDoS-attack appears in that log file.

We will take a look for simple implementation for botnet in demonstration purposes.

Further, we will analyze the software, which was used for creating botnet, by using dynamic and static analysis method.


**You should write report about each step you took to solve given tasks. Pure answer is not enough for credits.**

## **Task 1: Finding traces of DDoS attack**
In first task, you will analyze log file of targeted service provider.

Usage of different kind of Linux tools are required for successful completion.
Opening a log file in normal text editor potentially leads crashing of virtual machine.

*You will find log file from virtual machine folder DDoSIncident, named as **anonlog.txt**. It's here in folder [misc](misc) as compressed as well.*

***Tips:** grep, less, sort, cut, awk, uniq*

**A)**  Our first mission is to identify timewindow of attack. At what time (in which second) there were the most requests for server?

**B)** How servers were actually loaded/burdened? There were multiple requests for server at same time of course, but some weakness of service was also exploited.

**C)** At what time attack started? With help of section B. information, you are able to give valid guess. There were actually two episodes for attacks. We want to know earlier one.

**D)** What IP address(es) hypotetically points towards controller of botnet itself?
It can be seperated from any other requests on the server with good reasoning. It actually caused attacker to get caught.

## **Task 2-3: Malware - dynamic analysis** (Still in progress)
We have seen some consequences what the controller of botnet was able to produce. How he/she was able to create such a botnet?

The attacker had created multiple versions Trojan-like software.
Different versions of software was meant to target different groups of users - something what they would install to their machine.

In this case, software was mostly advertised as *Steam Code Generator 2016*; software which would give you any game you want! Software provided fancy graphical user interface, which showed huge list of games, and possibilty to get code for corresponding game. Obviously none of the codes were actually working. Advertisement was mostly perfomed in Youtube.

But like that wasn't enough, he created a new software: *League of Legends - Hacktool*, which was "hided" behind the naming *Steam Code Generator 2016*, so only special people would know about it. You were "able" to produce infinite amount of in-game currency with it.

At this point it might be already clear, that this software was indeed Trojan malware. Intention was not to give free Steam games or in-game currency for League of Legends game, instead software installed something unwanted to your pc, taking total control of it and finally making it part of botnet.

In this task, we are going to take a glance for this League of Legends Hacktool by making dynamic analysis for it.

### A) Preparing and playing around

Dynamical analysis (also known as behavior analysis) of  malware simply means running the malware, and inspecting the underlying system; how this program is behaving in there.

When you want to analyze malware, you don't want to usually infect your own machine. Instead you want to run it in some safe enviroment. Additionally easy way to undo changes would be helpful if you want to repeat process somewhat easily.

One good solution is to use virtual machines. Snapshot feature allows easy way to get back to situation, where you were before the moment of execution. Modern malwares might even detect virtual enviroments, and are not working there, but we are ignoring it now.

We have to use some nested virtual machines in this task. Our host is Windows, and currently we are running Ubuntu 16.04 as guest, now we are opening new Windows under Ubuntu.
This is required, if we want to use Linux as analyzing environment in later tasks, and because the limits of University's computers, we don't have suitable Linux host.

Now:
* On the desktop of Ubuntu, you will find folder named as this exercise. Inside it, there is folder 'malware', and inside it, there is zip file named as SteamCodeGenerator. Extract it. 
* Open VirtualBox in Ubuntu, and open 'Win7' virtual machine. This virtual machine should have snapshots already.

### B) Making the analysis

(6mins on average for disk compare analysis)

## **Task 4: Malware - static analysis**

Previously we have performed dynamic analysis for malware: inspecting the behavior of the malware by executing it.

Another way for analysing is to perform static analysis - we are not executing the malware, instead we are looking at the file(s) itself.

At first glance, if we haven't got much experience about reverse engineering, we might be seeing just some .exe files, and have no idea how to start.

But with some correct tools, we might see a lot, *particularly* in this case!

Let's see what basic Linux command *file* has to say:

```shell
$ file SteamCodeGenerator2016.exe
SteamCodeGenerator2016.exe: PE32 executable (GUI) Intel 80386 Mono/.Net assembly, for MS Windows
```

Looks like that we are probably facing .Net assembly.

One good tool for reversing these kind of executables is [dnSpy.](https://github.com/0xd4d/dnSpy), and we are using it as an example in this case.

You can find it [here](tools/) in tools folder as well.

It is portable tool, which is fully working assembly editor on Windows environment.
In Linux, we can use some of the properties of it, like console part.
We can decompile executables with it, which is enough for us.

Example for decompiling in Linux environment.
Go to dnSpy root directory:
```shell
mono dnSpy.Console.exe -o your/output/path path/to/your/malware.exe 
```
You will need to install [mono](https://www.mono-project.com) to your enviroment, if you want repeat it on another Linux than the one we have provided.

Once we disassemble these files, we can actually see whole source code as it's written.

Files are not protected at all.

This malware is written in Visual Basic and looks like it has been Microsoft Visual Studio project.

**Now, the intention of this task is to write short report what program is actually doing.** Since we can read program mostly in Visual Basic as it's written, it shouldn't be hard at all. (In most cases malwares are written in C language or protected somehow, and there we might need to read pure machine instructions instead.)
You are free to use any tools you want, as long as you are not analysing in your host system in unsafe environment. Even though this malware is not dangerous anymore, it's good to have principles.

**Answer at least to these questions in your report:**

### A) What's the role of SteamCodeGenerator.exe, keycrack.exe and steam-dll-pro.exe?

### B) How are they trying to hide their current/upcoming activites?

### C) What's the role of anti-cheat-bypass-tool.exe in Data folder?

* We are particularly interested about this file.
* This file contains actually two additional binaries. What are their names?
* Find a way to reverse these files as well, and include the purposes of these files as well to your report.
    * How bots were controlled? There were at least two ways.
    * Some source code of well known trojan malware was used as well, which one?
* We can find even more binaries, but analysing them goes out of the scope of this exersice.

### D) How well you were able to gather information from malware with dynamic analysis when compared to full reveal from source code?

## Task 5.

*Current ideas for level5 exercises*

Implement **one** of the described following tasks, and make step-by-step report (what,why and how) for what you did:

* Ever heard about WannaCry malware? In last year, this malware caused a lot of troubles in hospitals and other organisations. This malware was ransomware attack, and encrypted all the importants files of machine. It exploited some vulneralibities, which gave it self-spearding properties, making it a *worm*. Luckily there was a flaw (or intended property), which was so called *kill switch*, and stopped the spreading of malware in the cases, when machine was able to connect internet. Every time when malware was executed, it looked for domain hxxp://ifferfsodp9ifjaposdfjhgosurijfaewrwergwea[.]com/. If it does not exist, malware will continue execution, otherwise it will stop. **Your task is to make static analysis for this malware, and make step-by-step report, how you can find location of kill-switch in the code. Explain this function, which contains kill switch. It should not be too hard, as you already know the URL. You can use for example [radare2](https://github.com/radare/radare2) for reverse engineering this executable. In practise, we are disassembling binary to machine instructions, and looking the code of malware in assembly language.**

* **Something interesting** in botnets and malwares, but we haven't dealt with it yet? Feel free to implement and show us what you got.